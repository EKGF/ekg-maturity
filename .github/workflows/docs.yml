name: docs

on:
  push:
    branches:
    - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

env:
  HOMEBREW_NO_INSTALL_CLEANUP: 1

jobs:
  build:
    runs-on: macos-latest
    steps:
#      -
#        name: Install some tools
#        run: sudo apt-get install -y libcairo2-dev libfreetype6-dev libffi-dev libjpeg-dev libpng-dev libz-dev
#      -
#        name: Set up Homebrew
#        id: set-up-homebrew
#        uses: Homebrew/actions/setup-homebrew@master
      -
        name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      -
        name: Set up Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      -
        name: Clone sibling repositories
        run: |
          git clone --depth 1 https://github.com/EKGF/ekg-lib.git ../ekg-lib
          git clone --depth 1 https://github.com/EKGF/mkdocs-material-ekgf.git ../mkdocs-material-ekgf
      -
        name: Cache uv dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-
      -
        name: Install all MkDocs dependencies
        run: make --environment-overrides docs-install-github-actions
      -
        name: Build Site
        # Build runs on all branches and PRs to validate changes
        # run 'docs-build' twice because 'gen_files' doesn't let MkDocs
        # pick up on the generated files in the first run
        run: |
          make --environment-overrides docs-build
          make --environment-overrides docs-build
      -
        name: Deploy Site
        # Deploy only runs on main branch after successful build
        if: ${{ github.ref == 'refs/heads/main' }}
        run: make --environment-overrides docs-deploy


